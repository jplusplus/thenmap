<!DOCTYPE html>
<html lang="sv">
	<head>
		<meta charset=utf-8 />
		<meta name="viewport" content="width=device-width">

		<title>thenmap, test page</title>

		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
		<script>window.jquery || document.write('<script src="js/jquery.min.js"><\/script>')</script>
		
<!--		<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/i18next/1.6.3/i18next-1.6.3.min.js" />-->
		<script>window.i18n || document.write('<script src="js/i18next-1.7.1.min.js"><\/script>')</script>

		<script src="js/dragdealer.js"></script>
		<script src="js/jquery.csv-0.71.min.js"></script>
		
		<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/normalize/2.1.3/normalize.min.css">
		<!--[if lt IE 9]>
			<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->
	
		<style>
body {
	font-family: Arial, "sans-serif";
}

#thenmap-map-container{
	max-width:956px;
	margin-left:auto;margin-right:auto;
}

#thenmap-slider {
	margin-top:8px;
}

svg.thenmap-map {
	width:100%;
	height:100%;
}

.controlbar {
	margin-left:auto;margin-right:auto;
	max-width:280px;
	padding:0;
}

.control {
	font-size: 16px;
	font-weight: bold;
	cursor: pointer;
	background-color: #C00;
	color: #fff;
	padding: 4px 8px;
	margin: 4px 2px;
	border-radius: 3px;
	display: inline-block;
	text-align: center;
	outline:0;border:0;
}
.control:hover {
	background-color: #8A0000;
}
#thenmap-play {width: 90px;}
#thenmap-stepback,#thenmap-stepforward, #thenmap-rewind,#thenmap-rewind {width: 30px;}

.dragdealer {
	position: relative;
	height: 30px;
	background: #EEE;
}
.dragdealer .handle {
	position: absolute;
	cursor: pointer;
}
.dragdealer .red-bar {
	width: 100px;
	height: 30px;
	background: #C00;
	color: #FFF;
	line-height: 30px;
	text-align: center;
}
.dragdealer .disabled {
	background: #898989;
}
		</style>
	
	</head>

<body>
	<section id="thenmap">
	 	<div id="thenmap-map-container">
			<img id="thenmap-map" class="thenmap-map" src="maps/latest.svg"/>
	 	</div>
		<div id="thenmap-slider" class="dragdealer">
			<div class="red-bar handle"></div>
		</div>
		<menu class="controlbar">
			<input type=button id="thenmap-rewind" class="control" data-i18n="[value]controlbar.rewind;[title]controlbar.rewind-title" />
			<input type=button id="thenmap-stepback" class="control" data-i18n="[value]controlbar.stepback;[title]controlbar.stepback-title" />
			<input type=button id="thenmap-play" class="control" data-i18n="[value]controlbar.play" />
			<input type=button id="thenmap-stepforward" class="control" data-i18n="[value]controlbar.stepforward;[title]controlbar.stepforward-title" />
			<input type=button id="thenmap-gotoend" class="control" data-i18n="[value]controlbar.gotoend;[title]controlbar.gotoend-title" />
		</menu>
	</section>
		
	<script>
/************/
/* SETTINGS */
/************/
var startingYear = 1970;
var firstYear    = 1946;
var lastYear     = 2012;
var mapWidth     = 956;
var mapHeight    = 369;
var thenmapCurrentLanguage = 'sv';

/************/
/* MESSAGES */
/************/
var messages = 
{
 "sv": { translation: {
  "name"       : "ThenMap",
  "controlbar" : {
   "rewind"           : "⏮",
   "rewind-title"     : "Hoppa till början",
   "stepback"         : "◀",
   "stepback-title"   : "Förra",
   "play"             : "Spela upp",
   "pause"            : "Pausa",
   "stepforward"      : "▶",
   "stepforward-title": "Nästa",
   "gotoend"          : "⏭",
   "gotoend-title"    : "Hoppa till slutet" 
  }
 }}
}

/***************/
/*   MAP KEYS  */
/***************/

var mapKeys; //read from csv for now, for easier development

/* Init i18n, and translate all messages */
$(document).ready(function(){
	i18n.init({ lng: thenmapCurrentLanguage, 
				debug: true,
				/*useLocalStorage: true, */
				resStore: messages }, function() {
		$(".controlbar").i18n();
	});
});

/* Load map data */
$(document).ready(function() {
	$.ajax({
		type: "GET",
		url: "maps/keys.csv",
		dataType: "text",
		success: function(data) {
			mapKeys = $.csv.toObjects(data);//FIXME callback
		},
		error: function(e) {
			console.log("Error reading map keys: "+e);
		}
	});
});

/* Replace all SVG images with inline SVG */
$(document).ready(function(){

	/* Don't stretch map over it's witdh */
	$('#thenmap-map-container').css("max-width",mapWidth);

	var $thenmapmap = $('#thenmap-map');
	/* Replace img */
	var imgID = $thenmapmap.attr('id');
	var imgClass = $thenmapmap.attr('class');
	var imgURL = $thenmapmap.attr('src');

	$.get(imgURL, function(data) {
	    // Get the SVG tag, ignore the rest
	    var $svg = $(data).find('svg');

	    // Add replaced image's ID to the new SVG
	    if(typeof imgID !== 'undefined') {
	        $svg = $svg.attr('id', imgID);
	    }
	    // Add replaced image's classes to the new SVG
	    if(typeof imgClass !== 'undefined') {
	        $svg = $svg.attr('class', imgClass+' replaced-svg');
	    }

	    // Remove any invalid XML tags as per http://validator.w3.org
	    /* (we shouldn't have any) 
	    $svg = $svg.removeAttr('xmlns:a'); */

		$svg = $svg.attr('width', mapWidth);
		$svg = $svg.attr('height', mapHeight);

	    // Replace image with new SVG
	    $thenmapmap.replaceWith($svg);
	    
	    //Add markers
/*		    var year = $($img).data("year");
	    if (typeof spots[year] !== 'undefined' ) {
	    	$(spots[year]).each(function(){
console.log(this);
				var coords = mapProjection.projectToCSS(this.lat, this.lon);
console.log(coords);
		    	addMarkerAt('y1959', coords.x, coords.y);
		    });
	    }*/

	}, 'xml');

});

/* Init player */
$(document).ready(function(){
	/* Variables */	
	/* cache elements */
	var $thenmap = $("#thenmap");
	var $thenmapsvg = $thenmap.find('#thenmap-map');
	var $timelineHandle = $thenmap.find("#thenmap-slider .handle");
	var $playButton = $thenmap.find("#thenmap-play");
	var $isPlaying = false;
	var $currentYear = startingYear;
	var $dateOffset = "-07-01"; //Each map will show the world at this date of the year
	var timeline;
	var timer;
	
	/* We should have a list of id for each year, this is to slow */
	/* Fine for development, until we decided what map to use  */
	function printMap_old(y, svg){
		if ('undefined' != (typeof mapKeys)) {

			/* Hide all groups */
//			$(svg).find('#cshapes > g > g').css("display","none");
			$('svg > #cshapes > g > g').css("display","none");
			
			$(mapKeys).each(function(k,v) {
				var y1 = v["JSDATE,D"]; 
				var y2 = v["JEDATE,D"];

				// 1970-01-01 <= 1974-06-15 <= 1980-08-30
				if ((y1 <= ($currentYear+$dateOffset)) && (($currentYear+$dateOffset) <= y2)) {
					var key = +k+1;
					$('#cshapes_'+key).css("display","inline");
				}
			});
		}
	}
	
	function printMap(y, svg){
		
		if ($("#cshapes > g > g").length){
			$("#cshapes > g > g").each(function() {
				var y1 = $(this).data("start"); 
				var y2 = $(this).data("end"); 
				if ((y1 <= ($currentYear+$dateOffset)) && (($currentYear+$dateOffset) <= y2)) {
					$(this).css("display","inline");
				} else {
					$(this).css("display","none");			
				}

			});
/*		$(mapKeys).each(function(k,v) {
			var y1 = v["JSDATE,D"]; 
			var y2 = v["JEDATE,D"];

		});*/
		}
	}

	
	// Function to draw timeline
	function initTimeline(elementId, year0, year1, yearSelected) {
		var yearSpan = year1 - year0;
		timeline = new Dragdealer('thenmap-slider', {
			step: 1 / (yearSpan + 1), // How long is one step?
			x: 1 - (year1 - yearSelected) / yearSpan, // Set selected position
			snap: true,
			steps: yearSpan+1, // Number of steps
			animationCallback: function(x) {
				// Update handle and map
				$currentYear  = year0 + x * yearSpan; // Get selected year
				$timelineHandle.text($currentYear); // Update handle text
				printMap($currentYear, $thenmapsvg); // update map
			}/*,
			callback: function(x) {
				// Update map and do other stuff
				printMap($currentYear, $thenmapsvg);
			}*/
		});
	}
		
	// Function to play
	function playTimeline() {
		timer = setInterval(function() {
			if ( $currentYear <= lastYear ) {
				timeline.setStep(($currentYear++)-firstYear+2);
			} else {
				stopTimeline();
			}
		}, 500) // Set animation speed, 2000 = 2 sec
		$isPlaying = true;
		$playButton.val(i18n.t("controlbar.pause"));
	}
	// Function to stop timeline animation
	function stopTimeline() {
		clearInterval(timer);
		$isPlaying = false;
		$playButton.val(i18n.t("controlbar.play"));
	}
	
	// Play / pause
	$playButton.click(function() {
		if ($isPlaying) {
			stopTimeline();
		} else {
			playTimeline();
		}
	});
	
	// Step
	$thenmap.find("#thenmap-stepback").click(function() {
		if ($currentYear >= firstYear){
			timeline.setStep(($currentYear--)-firstYear);
		}
	});
	$thenmap.find("#thenmap-stepforward").click(function() {
		if ($currentYear <= lastYear) {
			timeline.setStep(($currentYear++)-firstYear+2);
		}
	});
	// Go first/last
	$thenmap.find("#thenmap-rewind").click(function() {
		timeline.setStep(0);
	});
	$thenmap.find("#thenmap-gotoend").click(function() {
		timeline.setStep(lastYear-firstYear+1);
	});
	
	// Init timeline
	initTimeline('thenmap-slider', firstYear, lastYear, startingYear);
	printMap($currentYear, $thenmapsvg);
});
		</script>
	</body>
</html>
